<div class="sigel-mobile-app-wrapper">
  <!-- Header Fixo com Stepper Progressivo -->
  <div class="sigel-app-header">
    <div class="container-fluid max-width-app">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 class="fw-bold text-dark mb-0">Vistoria Técnica</h4>
          <span class="badge-plate"><%= @vistoria.g_veiculo.placa %></span>
        </div>
        <div class="header-icon-badge">
          <iconify-icon icon="solar:checklist-minimalistic-bold-duotone" width="24"></iconify-icon>
        </div>
      </div>
      <!-- Stepper Visual -->
      <div class="sigel-stepper">
        <div class="step-item active" id="step-dot-1">
          <div class="step-number">1</div>
          <div class="step-label">Itens</div>
        </div>
        <div class="step-connector"></div>
        <div class="step-item" id="step-dot-2">
          <div class="step-number">2</div>
          <div class="step-label">Fotos</div>
        </div>
      </div>
    </div>
  </div>
  <div class="container-fluid max-width-app py-4" style="padding-bottom: 100px;">
    <%= form_with url: g_vistoria_veiculo_checklist_path(@vistoria), method: :post, local: true, multipart: true, id: "vistoria-form" do %>
      <!-- PASSO 1: DETALHAMENTO DOS ITENS -->
      <div id="step-content-1" class="step-content">
        <div class="section-title d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center gap-2">
            <iconify-icon icon="solar:clipboard-list-bold-duotone" class="fs-4"></iconify-icon>
            <h6 class="mb-0 fw-bold">1. DETALHAMENTO TÉCNICO</h6>
          </div>
          <button type="button" class="btn-add-pill" onclick="adicionarItem()">
            <iconify-icon icon="solar:add-circle-bold"></iconify-icon> Novo
          </button>
        </div>
        <div id="itens-checklist">
          <% if @existentes.any? %>
            <% @existentes.each_with_index do |item, idx| %>
              <%= render 'item_checklist_fields', item: item, idx: idx %>
            <% end %>
          <% end %>
        </div>
        <button type="button" class="btn btn-outline-add w-100 mt-3 shadow-sm" onclick="adicionarItem()">
          <iconify-icon icon="solar:add-square-bold-duotone" class="fs-5"></iconify-icon>
          ADICIONAR MAIS ITENS
        </button>
      </div>
      <!-- PASSO 2: REGISTRO FOTOGRÁFICO (Oculto inicialmente) -->
      <div id="step-content-2" class="step-content d-none">
        <div class="section-title mb-3">
          <div class="d-flex align-items-center gap-2">
            <iconify-icon icon="solar:camera-add-bold-duotone" class="fs-4"></iconify-icon>
            <h6 class="mb-0 fw-bold">2. REGISTRO FOTOGRÁFICO</h6>
          </div>
        </div>
        <div class="alert alert-info py-2 px-3 mb-4 rounded-4 border-0" style="background: #e0f2f1; color: #004d40;">
          <small><iconify-icon icon="solar:info-circle-bold" class="me-1"></iconify-icon> Toque nos ícones abaixo para abrir a câmera.</small>
        </div>
        <div class="row g-2">
          <% ["Frente", "Traseira", "Lateral Esq.", "Lateral Dir.", "Interior", "Motor"].each do |label| %>
            <div class="col-6 col-md-4">
              <div class="photo-upload-card shadow-sm">
                <input type="file" name="fotos[<%= label.parameterize %>]" accept="image/*" onchange="previewImage(this)">
                <div class="upload-placeholder text-center">
                  <iconify-icon icon="solar:camera-minimalistic-bold-duotone" class="fs-2 mb-1"></iconify-icon>
                  <span><%= label %></span>
                </div>
                <img class="photo-preview">
                <div class="check-overlay"><iconify-icon icon="solar:check-circle-bold"></iconify-icon></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      <!-- BARRA DE AÇÕES INFERIOR -->
      <div class="app-footer-actions">
        <div class="container-fluid max-width-app">
          <div class="row g-2">
            <!-- Botão Voltar (Altera comportamento dependendo do passo) -->
            <div class="col-4">
              <button type="button" id="btn-prev" class="btn btn-app-secondary w-100 py-3" onclick="prevStep()" disabled>
                <iconify-icon icon="solar:alt-arrow-left-bold" class="fs-4"></iconify-icon>
              </button>
            </div>
            <!-- Botão Avançar / Finalizar -->
            <div class="col-8">
              <button type="button" id="btn-next" class="btn btn-app-primary w-100 py-3" onclick="nextStep()">
                <strong id="next-label">AVANÇAR PARA FOTOS</strong>
              </button>
              <button type="submit" id="btn-submit" class="btn btn-app-success w-100 py-3 d-none">
                <strong>FINALIZAR VISTORIA</strong>
              </button>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
<!-- Template do Item -->
<template id="item-template">
  <div class="card checklist-card mb-3 animate-fade-in border-0 shadow-sm">
    <button type="button" class="btn-remove-item" onclick="removerItem(this)">
      <iconify-icon icon="solar:close-circle-bold"></iconify-icon>
    </button>
    <div class="card-body p-3">
      <div class="row g-3">
        <div class="col-12">
          <label class="app-label">ITEM AVALIADO</label>
          <select name="itens[][g_tipo_item_checklist_id]" class="form-select custom-app-input" required>
            <option value="">Selecione o item...</option>
            <% @tipos_itens.each do |tipo| %><option value="<%= tipo.id %>"><%= tipo.descricao %></option><% end %>
          </select>
        </div>
        <div class="col-6">
          <label class="app-label">ESTADO</label>
          <select name="itens[][g_estado_conservacao_veiculo_id]" class="form-select custom-app-input" required>
            <option value="">Status...</option>
            <% @estados.each do |estado| %><option value="<%= estado.id %>"><%= estado.descricao %></option><% end %>
          </select>
        </div>
        <div class="col-6">
          <label class="app-label">NOTA/SCORE</label>
          <input type="number" step="0.1" name="itens[][resultado]" class="form-control custom-app-input text-center fw-bold" placeholder="0.0" required>
        </div>
        <div class="col-12">
          <label class="app-label">OBSERVAÇÕES</label>
          <textarea name="itens[][observacao]" class="form-control custom-app-input" rows="2" placeholder="Descreva avarias..."></textarea>
        </div>
      </div>
    </div>
  </div>
</template>
<style>
  :root {
    --sigel-verde: #004d40;
    --sigel-accent: #1de9b6;
    --sigel-bg: #f8faf9;
    --sigel-text: #2c3e50;
  }

  body { background-color: var(--sigel-bg); color: var(--sigel-text); font-family: 'Inter', sans-serif; }
  .max-width-app { max-width: 600px; margin: 0 auto; }

  /* Stepper Horizontal */
  .sigel-stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 1rem;
    padding: 0 10%;
  }
  .step-item { text-align: center; position: relative; z-index: 1; }
  .step-number {
    width: 32px; height: 32px;
    background: #e0e0e0;
    color: #888;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 0.9rem;
    margin: 0 auto 4px;
    transition: 0.3s;
  }
  .step-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #aaa; }
  .step-connector { flex-grow: 1; height: 3px; background: #e0e0e0; margin: -18px 10px 0; border-radius: 2px; }

  .step-item.active .step-number { background: var(--sigel-verde); color: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,77,64,0.2); }
  .step-item.active .step-label { color: var(--sigel-verde); }
  .step-item.completed .step-number { background: var(--sigel-accent); color: white; }
  .step-item.completed .step-label { color: var(--sigel-accent); }

  /* Header Estilo Nativo */
  .sigel-app-header {
    background: white;
    padding: 1rem 0;
    border-bottom: 1px solid #eee;
    position: sticky; top: 0; z-index: 1020;
    box-shadow: 0 2px 10px rgba(0,0,0,0.02);
  }
  .badge-plate { background: #222; color: white; padding: 2px 10px; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: bold; }
  /* Ajuste para os botões não serem 'gigantes' no mobile */
  .btn-app-primary, .btn-app-secondary, .btn-app-success {
  padding: 10px !important; /* Diminuído de 15px para 10px */
  font-size: 0.85rem !important;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 50px; /* Altura fixa para manter o padrão visual */
  }

  /* Garante que o conteúdo não fique escondido atrás do footer quando o teclado fechar */
  .sigel-mobile-app-wrapper {
  padding-bottom: 80px;
  }

  /* Melhora o Stepper em telas pequenas para não encavalar */
  @media (max-width: 400px) {
  .sigel-stepper {
    padding: 0 5%;
  }
  .step-label {
    font-size: 0.55rem;
  }
  }
  /* Cards de Foto */
  .photo-upload-card {
    background: white;
    border: 2px dashed #ddd;
    border-radius: 16px;
    aspect-ratio: 1/1;
    position: relative;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s ease-in-out;
  }
  .photo-upload-card:active { transform: scale(0.95); background: #f1f8f7; }
  .photo-upload-card input { position: absolute; width: 100%; height: 100%; opacity: 0; z-index: 3; cursor: pointer; }
  .upload-placeholder span { display: block; font-size: 0.7rem; font-weight: 800; color: #999; margin-top: 4px; }
  .upload-placeholder iconify-icon { color: #ccc; }
  .photo-preview { position: absolute; width: 100%; height: 100%; object-fit: cover; border-radius: 14px; display: none; z-index: 1; }
  .check-overlay { position: absolute; top: 8px; right: 8px; color: var(--sigel-accent); background: white; border-radius: 50%; display: none; z-index: 2; line-height: 1; }

  /* Formulário e Cards */
  .checklist-card { border-radius: 20px; border-left: 6px solid var(--sigel-verde) !important; }
  .app-label { font-size: 0.6rem; font-weight: 800; color: #95a5a6; margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
  .custom-app-input { border-radius: 12px; background: #fbfcfc; border: 1px solid #ebedef; padding: 0.7rem; font-size: 0.95rem; font-weight: 500; }
  .custom-app-input:focus { border-color: var(--sigel-verde); box-shadow: none; background: white; }

  .btn-remove-item {
    position: absolute; top: -8px; right: -8px;
    background: white; border: none; color: #e74c3c;
    border-radius: 50%; padding: 0; font-size: 1.8rem; line-height: 1;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10;
  }

  .btn-add-pill { background: #e0f2f1; color: var(--sigel-verde); border: none; border-radius: 50px; padding: 5px 15px; font-size: 0.75rem; font-weight: 800; }
  .btn-outline-add { border: 2px dashed #ccc; color: #999; background: white; border-radius: 20px; padding: 1.5rem; font-weight: 800; font-size: 0.8rem; }

  /* Footer Fixo */
  .app-footer-actions {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(15px);
    padding: 15px 0 25px; /* Mais espaço para o "home bar" do iPhone */
    border-top: 1px solid #eee;
    z-index: 1030;
  }
  .btn-app-primary { background: var(--sigel-verde); color: white; border-radius: 16px; border: none; font-size: 0.9rem; letter-spacing: 0.5px; }
  .btn-app-secondary { background: #f1f3f4; color: #5f6368; border-radius: 16px; border: none; }
  .btn-app-success { background: #16a085; color: white; border-radius: 16px; border: none; font-size: 1rem; }

  .animate-fade-in { animation: fadeInUp 0.4s both; }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
<script>
  let currentStep = 1;

  function nextStep() {
    if (currentStep === 1) {
      // Transição Passo 1 -> 2
      document.getElementById('step-content-1').classList.add('d-none');
      document.getElementById('step-content-2').classList.remove('d-none');

      document.getElementById('step-dot-1').classList.remove('active');
      document.getElementById('step-dot-1').classList.add('completed');
      document.getElementById('step-dot-2').classList.add('active');

      document.getElementById('btn-prev').disabled = false;
      document.getElementById('btn-next').classList.add('d-none');
      document.getElementById('btn-submit').classList.remove('d-none');

      currentStep = 2;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function prevStep() {
    if (currentStep === 2) {
      // Transição Passo 2 -> 1
      document.getElementById('step-content-2').classList.add('d-none');
      document.getElementById('step-content-1').classList.remove('d-none');

      document.getElementById('step-dot-2').classList.remove('active');
      document.getElementById('step-dot-1').classList.remove('completed');
      document.getElementById('step-dot-1').classList.add('active');

      document.getElementById('btn-prev').disabled = true;
      document.getElementById('btn-next').classList.remove('d-none');
      document.getElementById('btn-submit').classList.add('d-none');

      currentStep = 1;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function previewImage(input) {
    const card = input.closest('.photo-upload-card');
    const preview = card.querySelector('.photo-preview');
    const placeholder = card.querySelector('.upload-placeholder');
    const check = card.querySelector('.check-overlay');

    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        check.style.display = 'block';
        card.style.borderStyle = 'solid';
        card.style.borderColor = 'var(--sigel-accent)';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }

  function adicionarItem() {
    const container = document.getElementById("itens-checklist");
    const template = document.getElementById("item-template");
    const clone = template.content.cloneNode(true);
    container.appendChild(clone);
  }

  function removerItem(btn) {
    btn.closest(".checklist-card").remove();
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (document.querySelectorAll('.checklist-card').length === 0) {
      adicionarItem();
    }
  });
  // Detecta quando o usuário clica em qualquer input para esconder a barra de botões
  document.addEventListener('focusin', (e) => {
  if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
    const footer = document.querySelector('.app-footer-actions');
    if (footer) footer.style.display = 'none';
  }
  });

  // Detecta quando o usuário sai do campo para mostrar a barra de novo
  document.addEventListener('focusout', (e) => {
  if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
    const footer = document.querySelector('.app-footer-actions');
    if (footer) footer.style.display = 'block';
  }
  });
</script>