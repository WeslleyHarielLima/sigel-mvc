<div class="sigel-container animate-fade-in mb-5" style="max-width: 900px; margin: 0 auto; padding: 1rem;">
  <!-- Cabeçalho Compacto -->
  <header class="mb-4 d-flex justify-content-between align-items-center">
    <div>
      <h3 class="fw-bold text-dark mb-0">Vistoria Técnica</h3>
      <span class="badge bg-dark">Placa: <%= @vistoria.g_veiculo.placa %></span>
      <span class="text-muted small ms-2"><%= @vistoria.g_veiculo.modelo %></span>
    </div>
    <div class="text-end">
      <iconify-icon icon="solar:checklist-minimalistic-bold-duotone" width="40" style="color: var(--sigel-green)"></iconify-icon>
    </div>
  </header>
  <%= form_with url: g_vistoria_veiculo_checklist_path(@vistoria), method: :post, local: true, multipart: true do %>
    <!-- SEÇÃO 1: GALERIA FOTOGRÁFICA (6 FOTOS PADRÃO) -->
    <div class="sigel-panel-human mb-4 border-0 shadow-sm p-3">
      <h6 class="fw-bold mb-3 text-uppercase small text-muted">1. Registro Fotográfico Obrigatório</h6>
      <div class="row g-2">
        <% ["Frente", "Traseira", "Lateral Esq.", "Lateral Dir.", "Interior", "Motor"].each do |label| %>
          <div class="col-4 col-md-2">
            <div class="photo-upload-card" title="Clique para tirar foto: <%= label %>">
              <i class="bi bi-camera"></i>
              <span><%= label %></span>
              <input type="file" name="fotos[<%= label.parameterize %>]" accept="image/*" onchange="previewImage(this)">
              <img class="photo-preview">
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <!-- SEÇÃO 2: ITENS DA VISTORIA -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="fw-bold mb-0 text-uppercase small text-muted">2. Detalhamento dos Itens</h6>
      <button type="button" class="btn btn-sm btn-success rounded-pill px-3" onclick="adicionarItem()">
        <i class="bi bi-plus-circle me-1"></i> Adicionar Item
      </button>
    </div>
    <div id="itens-checklist">
      <% if @existentes.any? %>
        <% @existentes.each_with_index do |item, idx| %>
          <%= render 'item_checklist_fields', item: item, idx: idx %>
        <% end %>
      <% end %>
    </div>
    <!-- Botão Adicionar Central (UX Mobile) -->
    <div class="text-center my-4">
      <button type="button" class="btn btn-outline-success btn-lg w-100 rounded-pill border-2" onclick="adicionarItem()">
        <i class="bi bi-plus-lg"></i> Novo Item
      </button>
    </div>
    <!-- AÇÕES FIXAS NO RODAPÉ (UX MOBILE) -->
    <div class="sticky-bottom-actions mt-5 d-flex gap-2">
      <%= link_to "Cancelar", fluxo_avaliacao_path, class: "btn btn-outline-secondary btn-lg flex-grow-1" %>
      <button type="submit" class="btn btn-success btn-lg flex-grow-2 px-5">
        <strong>FINALIZAR VISTORIA</strong>
      </button>
    </div>
  <% end %>
</div>
<!-- Template Oculto para Novos Itens (Melhora performance e manutenção) -->
<template id="item-template">
  <div class="card checklist-card mb-4 animate-fade-in p-3 position-relative">
    <button type="button" class="btn btn-danger btn-remove shadow-sm" onclick="removerItem(this)">
      <i class="bi bi-x"></i>
    </button>
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <label class="form-label small fw-bold">O que está avaliando?</label>
        <select name="itens[][g_tipo_item_checklist_id]" class="form-select form-select-lg" required>
          <option value="">Selecione o item...</option>
          <% @tipos_itens.each do |tipo| %>
            <option value="<%= tipo.id %>"><%= tipo.descricao %></option>
          <% end %>
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label small fw-bold">Estado</label>
        <select name="itens[][g_estado_conservacao_veiculo_id]" class="form-select form-select-lg" required>
          <option value="">Status...</option>
          <% @estados.each do |estado| %>
            <option value="<%= estado.id %>"><%= estado.descricao %></option>
          <% end %>
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label small fw-bold">Nota/Resultado</label>
        <input type="number" step="0.1" name="itens[][resultado]" class="form-control form-control-lg text-center" placeholder="0.0" required>
      </div>
      <div class="col-12">
        <label class="form-label small fw-bold">Observações Adicionais</label>
        <textarea name="itens[][observacao]" class="form-control" rows="2" placeholder="Detalhes técnicos, avarias, etc..."></textarea>
      </div>
    </div>
  </div>
</template>
<script>
  function adicionarItem() {
    const container = document.getElementById("itens-checklist");
    const template = document.getElementById("item-template");
    const clone = template.content.cloneNode(true);
    container.appendChild(clone);
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }

  function removerItem(btn) {
    if(confirm("Deseja remover este item da vistoria?")) {
      btn.closest(".checklist-card").classList.add("animate-fade-out");
      setTimeout(() => btn.closest(".checklist-card").remove(), 300);
    }
  }

  function previewImage(input) {
    const card = input.closest('.photo-upload-card');
    const preview = card.querySelector('.photo-preview');
    const icon = card.querySelector('i');

    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        icon.style.display = 'none';
        card.style.borderColor = '#1de9b6';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }

  // Iniciar com um item se estiver vazio
  document.addEventListener("DOMContentLoaded", () => {
    if (document.querySelectorAll('.checklist-card').length === 0) {
      adicionarItem();
    }
  });
</script>
<style>
  :root { --sigel-green: #004d40; --sigel-accent: #1de9b6; }
  .photo-upload-card {
    border: 2px dashed #ccc;
    border-radius: 12px;
    height: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9fa;
    position: relative;
    overflow: hidden;
  }
  .photo-upload-card:hover { border-color: var(--sigel-green); background: #e0f2f1; }
  .photo-upload-card input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
  .photo-upload-card i { font-size: 1.5rem; color: var(--sigel-green); }
  .photo-upload-card span { font-size: 0.75rem; font-weight: bold; margin-top: 5px; color: #666; text-align: center; }
  .photo-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; }

  .checklist-card {
    border: none;
    border-left: 5px solid var(--sigel-green);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  .sticky-bottom-actions {
    position: sticky;
    bottom: 0;
    background: white;
    padding: 1rem;
    box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
    z-index: 1000;
  }
  .btn-remove { position: absolute; top: -10px; right: -10px; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; padding: 0; }
</style>